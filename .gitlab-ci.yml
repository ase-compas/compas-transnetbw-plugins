image: node:20

stages:
  - install_dependencies
  - build
  - deploy
  - pages
  - cleanup

# Cache configuration for Bun dependencies
cache: &bun_cache
  key:
    files:
      - bun.lockb
  paths:
    - node_modules/
  policy: pull-push

# Install dependencies using Bun
install_dependencies:
  before_script:
    - npm install -g bun

  stage: install_dependencies
  interruptible: false
  cache:
    <<: *bun_cache
  script:
    - node -v
    - bun install --frozen-lockfile --no-progress --non-interactive

# Build project using Bun
build_project:
  before_script:
    - npm install -g bun nx
  stage: build
  cache:
    <<: *bun_cache
  script:
    - echo "Building project..."
    - bun run build:version-editor
  dependencies:
    - install_dependencies
  artifacts:
    name: "build-${CI_COMMIT_REF_SLUG}"
    paths:
      - dist/apps/version-editor
    expire_in: 1 week

pages:
  stage: deploy
  script:
    - echo "Deploying to GitLab Pages..."
    - mkdir public
    - cp -r dist/apps/version-editor/* public/
  dependencies:
    - build_project
  artifacts:
    paths:
      - public
  only:
    - main
